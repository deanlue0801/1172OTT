<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¯ç›Ÿçˆ­éœ¸è³½åˆ†æ - å’Œé¢¨ç‰ˆ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Noto+Serif+TC:wght@600&display=swap" rel="stylesheet">
<style>
        /* --- ã€Œå’Œé¢¨ãƒ»éœè—ã€ä¸»é¡Œ --- */
        :root {
            --bg-color: #f8f7f2; /* ç±³ç™½èƒŒæ™¯ */
            --card-bg: #ffffff;  /* ç´”ç™½å¡ç‰‡ */
            --text-dark: #34495e; /* ä¸»è¦æ–‡å­—: æ·±æ¿å²©ç° */
            --text-light: #7f8c8d;/* æ¬¡è¦æ–‡å­—: æ·ºç°è‰² */
            --accent-indigo: #465a8b; /* ä¸»è¦é»ç¶´: é›è— */
            --accent-vermilion: #c0392b; /* æ¬¡è¦é»ç¶´/æŒ‰éˆ•: æœ±å°ç´… */
            --border-color: #e0e0e0; /* é‚Šæ¡†é¡è‰² */
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--bg-color);
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='80' height='80' viewBox='0 0 80 80'%3E%3Cg fill='%23e4e4e4' fill-opacity='0.4'%3E%3Cpath fill-rule='evenodd' d='M11 0l5 20H6l5-20zm42 31a3 3 0 1 0 0-6 3 3 0 0 0 0 6zM0 72h40v4H0v-4zm0-8h31.4v4H0v-4zm20-16h20v4H20v-4zM0 56h40v4H0v-4zm0-8h20v4H0v-4zm0-16h40v4H0v-4zm0-8h20v4H0v-4zM40 0h40v4H40v-4zm0 8h31.4v4H40v-4zm0 16h40v4H40v-4zm0-8h20v4H40v-4zm0 32h40v4H40v-4zm0-8h20v4H40v-4zM20 16h20v4H20v-4zM0 16h20v4H0v-4z'/%3E%3C/g%3E%3C/svg%3E");
            color: var(--text-dark);
        }

        /* æ¨™é¡Œèˆ‡å­—é«” */
        .display-5, .card-header, .text-danger {
            font-family: 'Noto Serif TC', serif;
            font-weight: 600;
        }
        .text-danger {
            color: var(--accent-vermilion) !important;
        }

        /* â–¼â–¼â–¼ ä¿®æ”¹å¾Œçš„ Header æ’ç‰ˆ â–¼â–¼â–¼ */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* å¡ç‰‡æ¨£å¼ */
        .card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
        }
        .card:hover {
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
            transform: translateY(-2px);
        }
        .card-header {
            background-color: transparent;
            border-bottom: 2px solid var(--accent-indigo);
            color: var(--accent-indigo);
            padding-bottom: 0.75rem;
        }

        textarea.form-control,
        input.form-control {
            background-color: #fdfdfd;
            border-color: #dcdcdc;
            color: var(--text-dark) !important;
        }
        .form-control:focus {
            border-color: var(--accent-indigo);
            box-shadow: 0 0 0 0.25rem rgba(70, 90, 139, 0.2);
        }
        .input-group-text {
            background-color: #e9ecef;
            border-color: #dcdcdc;
            color: var(--text-dark);
        }
        .data-input {
            font-family: monospace;
            font-size: 0.9em;
            line-height: 1.6;
        }

        /* â–¼â–¼â–¼ æ–°å¢é¦–é æŒ‰éˆ•çš„æ¨£å¼ â–¼â–¼â–¼ */
        .btn-home {
            border: 1px solid var(--border-color);
            color: var(--text-light);
            font-weight: 500;
            text-decoration: none;
            transition: all 0.2s ease-in-out;
        }
        .btn-home:hover {
            background-color: var(--accent-indigo);
            border-color: var(--accent-indigo);
            color: white;
            transform: scale(1.05);
        }

        /* æŒ‰éˆ•æ¨£å¼ */
        .btn-primary {
            background-color: var(--accent-vermilion);
            border-color: var(--accent-vermilion);
            font-weight: 700;
            padding: 0.5rem 1rem;
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            background-color: #a53125;
            border-color: #a53125;
            box-shadow: 0 4px 15px rgba(192, 57, 43, 0.3);
            transform: translateY(-3px);
        }

        /* çµæœé¡¯ç¤ºå€ */
        #results-container {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 25px;
        }
        #results {
            background-color: #f5f5f5;
            padding: 20px;
            border-radius: 0.5rem;
            border: 1px solid #e0e0e0;
        }
        .team-list { font-size: 0.8em; word-break: break-all; }
        .table-success { --bs-table-bg: #e6f5f3; --bs-table-color: #0f5132; }
        .table-danger { --bs-table-bg: #f8d7da; --bs-table-color: #842029; }
    </style>
</head>
<body class="container py-4">

    <header class="pb-3 mb-4 border-bottom">
        <h1 class="display-5">è¯ç›Ÿçˆ­éœ¸è³½ + æˆ°åŠ›ç¸½å’Œåˆ†æ (ç¶²é ç‰ˆ)</h1>
		<a href="/" class="btn btn-home">ğŸ  é¦–é </a>
		    </header>
    <main>
        <div class="card mb-4">
            <div class="card-header">æ•¸æ“šè¼¸å…¥å€</div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-lg-12">
                        <h5>æˆ‘æ–¹æˆ°åŠ›æ•¸æ“š (60çµ„)</h5>
                        <div class="mb-2">
                            <label for="our-power-file" class="form-label small text-muted">æˆ–å¾ Excel æª”æ¡ˆ (.xlsx, .xls) è®€å– (ç¬¬ä¸€æ¬„:ç·¨è™Ÿ, ç¬¬äºŒæ¬„:æˆ°åŠ›)ï¼š</label>
                            <input class="form-control form-control-sm" type="file" id="our-power-file" accept=".xlsx, .xls">
                        </div>
                        <textarea id="our-power" class="form-control data-input" rows="8"></textarea>
                    </div>
                    <div class="col-lg-4">
                        <h5 class="text-danger">æ•µå·¦ (20çµ„)</h5>
                        <div class="mb-2">
                            <label for="enemy-left-file" class="form-label small text-muted">å¾ Excel è®€å–ï¼š</label>
                            <input class="form-control form-control-sm" type="file" id="enemy-left-file" accept=".xlsx, .xls">
                        </div>
                        <textarea id="enemy-left" class="form-control data-input" rows="8"></textarea>
                    </div>
                    <div class="col-lg-4">
                        <h5 class="text-danger">æ•µä¸­ (20çµ„)</h5>
                        <div class="mb-2">
                            <label for="enemy-center-file" class="form-label small text-muted">å¾ Excel è®€å–ï¼š</label>
                            <input class="form-control form-control-sm" type="file" id="enemy-center-file" accept=".xlsx, .xls">
                        </div>
                        <textarea id="enemy-center" class="form-control data-input" rows="8"></textarea>
                    </div>
                    <div class="col-lg-4">
                        <h5 class="text-danger">æ•µå³ (20çµ„)</h5>
                        <div class="mb-2">
                            <label for="enemy-right-file" class="form-label small text-muted">å¾ Excel è®€å–ï¼š</label>
                            <input class="form-control form-control-sm" type="file" id="enemy-right-file" accept=".xlsx, .xls">
                        </div>
                        <textarea id="enemy-right" class="form-control data-input" rows="8"></textarea>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">æ¨¡æ“¬èˆ‡åˆ†æ</div>
            <div class="card-body">
                <div class="row align-items-end g-3">
                    <div class="col-lg-8">
                        <h6>ğŸ¯ ç²¾ç¢ºåˆ†çµ„å„ªåŒ–</h6>
                        <div class="row">
                            <div class="col-md-4"><div class="input-group"><span class="input-group-text">å·¦è·¯å„ªå‹¢</span><input type="number" id="left-advantage" class="form-control" value="2000"></div></div>
                            <div class="col-md-4"><div class="input-group"><span class="input-group-text">ä¸­è·¯å„ªå‹¢</span><input type="number" id="center-advantage" class="form-control" value="2000"></div></div>
                            <div class="col-md-4"><div class="input-group"><span class="input-group-text">å³è·¯å„ªå‹¢</span><input type="number" id="right-advantage" class="form-control" value="2000"></div></div>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="d-grid gap-2">
                            <button id="optimize-btn" class="btn btn-primary btn-lg">åŸ·è¡Œç²¾ç¢ºåˆ†çµ„</button>
                            <button id="reset-btn" class="btn btn-secondary">é‚„åŸé è¨­æ•¸æ“š</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="results-container">
            <h4>åˆ†æçµæœ</h4>
            <div id="results">çµæœå°‡æœƒé¡¯ç¤ºåœ¨é€™è£¡...</div>
        </div>
    </main>

    <footer class="pt-3 mt-4 text-muted border-top">&copy; 2025 - æˆ°æƒ…åˆ†æä¸­å¿ƒ</footer>

    <script>
        // ç‚ºäº†ç‰ˆé¢æ•´æ½”ï¼ŒJavaScript ç¨‹å¼ç¢¼èˆ‡ä¸Šä¸€å€‹ç‰ˆæœ¬å®Œå…¨ç›¸åŒï¼Œæ­¤è™•çœç•¥ã€‚
        // æ‚¨åœ¨è¤‡è£½è²¼ä¸Šæ™‚ï¼ŒæœƒåŒ…å«å®Œæ•´çš„ script å€å¡Šã€‚
        document.addEventListener('DOMContentLoaded', function() {
            const defaultData = {
                ourPower: "1 2459 2 2635 3 2683 4 2694 5 2697 6 2730 7 2741 8 2748 9 2754 10 2778 11 2793 12 2816 13 2845 14 2858 15 2887 16 2888 17 2904 18 2921 19 2932 20 2949 21 2950 22 2968 23 2997 24 3040 25 3044 26 3066 27 3083 28 3084 29 3092 30 3093 31 3136 32 3169 33 3191 34 3218 35 3220 36 3221 37 3243 38 3246 39 3256 40 3266 41 3283 42 3289 43 3305 44 3306 45 3339 46 3341 47 3378 48 3380 49 3398 50 3535 51 3613 52 3748 53 3782 54 3819 55 4010 56 4155 57 4164 58 4498 59 5490 60 6223",
                enemyLeft: "1 2957 2 3610 3 3371 4 2948 5 3676 6 2923 7 3929 8 3519 9 3738 10 3662 11 3705 12 3937 13 3383 14 2893 15 4019 16 3019 17 2856 18 3231 19 3909 20 2946",
                enemyCenter: "1 2599 2 2790 3 3339 4 2930 5 2770 6 3656 7 2991 8 2820 9 3720 10 2673 11 2773 12 2858 13 2921 14 2482 15 3130 16 3567 17 3732 18 2773 19 3033 20 3291",
                enemyRight: "1 2787 2 3182 3 2500 4 3193 5 1809 6 2055 7 2335 8 1957 9 2246 10 2863 11 2616 12 2141 13 2944 14 1873 15 2511 16 1860 17 2797 18 2152 19 3127 20 2793"
            };
            const elements = {
                ourPower: document.getElementById('our-power'),
                enemyLeft: document.getElementById('enemy-left'),
                enemyCenter: document.getElementById('enemy-center'),
                enemyRight: document.getElementById('enemy-right'),
                leftAdvantage: document.getElementById('left-advantage'),
                centerAdvantage: document.getElementById('center-advantage'),
                rightAdvantage: document.getElementById('right-advantage'),
                optimizeBtn: document.getElementById('optimize-btn'),
                resetBtn: document.getElementById('reset-btn'),
                resultsDiv: document.getElementById('results'),
                ourPowerFile: document.getElementById('our-power-file'),
                enemyLeftFile: document.getElementById('enemy-left-file'),
                enemyCenterFile: document.getElementById('enemy-center-file'),
                enemyRightFile: document.getElementById('enemy-right-file')
            };
            function resetToDefaults() {
                elements.ourPower.value = defaultData.ourPower;
                elements.enemyLeft.value = defaultData.enemyLeft;
                elements.enemyCenter.value = defaultData.enemyCenter;
                elements.enemyRight.value = defaultData.enemyRight;
                elements.leftAdvantage.value = "2000";
                elements.centerAdvantage.value = "2000";
                elements.rightAdvantage.value = "2000";
                elements.resultsDiv.innerHTML = '<p class="text-muted">å·²é‚„åŸç‚ºé è¨­æ•¸æ“šã€‚è«‹é»æ“ŠæŒ‰éˆ•é–‹å§‹åˆ†æã€‚</p>';
                elements.ourPowerFile.value = '';
                elements.enemyLeftFile.value = '';
                elements.enemyCenterFile.value = '';
                elements.enemyRightFile.value = '';
            }
            function handleExcelUpload(file, targetTextarea) {
                if (!file) { return; }
                targetTextarea.value = 'æ­£åœ¨å¾ Excel æª”æ¡ˆè®€å–æ•¸æ“š...';
                const formData = new FormData();
                formData.append('excel_file', file);
                fetch('/api/upload_excel', { method: 'POST', body: formData })
                .then(response => {
                    if (!response.ok) { return response.json().then(err => { throw new Error(err.error || 'ä¼ºæœå™¨éŒ¯èª¤') }); }
                    return response.json();
                })
                .then(data => { targetTextarea.value = data.power_text; })
                .catch(error => {
                    alert(`è®€å– Excel æª”æ¡ˆå¤±æ•—ï¼š\n${error.message}`);
                    targetTextarea.value = '';
                });
            }
            elements.ourPowerFile.addEventListener('change', (event) => handleExcelUpload(event.target.files[0], elements.ourPower));
            elements.enemyLeftFile.addEventListener('change', (event) => handleExcelUpload(event.target.files[0], elements.enemyLeft));
            elements.enemyCenterFile.addEventListener('change', (event) => handleExcelUpload(event.target.files[0], elements.enemyCenter));
            elements.enemyRightFile.addEventListener('change', (event) => handleExcelUpload(event.target.files[0], elements.enemyRight));
            elements.optimizeBtn.addEventListener('click', function() {
                elements.resultsDiv.innerHTML = `<div class="d-flex align-items-center"><div class="spinner-border spinner-border-sm me-2" role="status"></div><strong>å¾Œç«¯ä¼ºæœå™¨è¨ˆç®—ä¸­...</strong></div>`;
                const dataToSend = {
                    our_power: elements.ourPower.value,
                    enemy_left: elements.enemyLeft.value,
                    enemy_center: elements.enemyCenter.value,
                    enemy_right: elements.enemyRight.value,
                    left_advantage: elements.leftAdvantage.value,
                    center_advantage: elements.centerAdvantage.value,
                    right_advantage: elements.rightAdvantage.value
                };
                fetch('/api/precise_optimization', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(dataToSend)
                })
                .then(response => {
                    if (!response.ok) { return response.json().then(err => { throw new Error(err.error || 'ä¼ºæœå™¨éŒ¯èª¤') }); }
                    return response.json();
                })
                .then(result => {
                    let allocationHtml = '';
                    if (result.best_allocation) {
                        const allocation = result.best_allocation;
                        const laneOrder = ['left', 'center', 'right'];
                        let allocationTables = laneOrder.map(laneName => {
                            const laneData = allocation.lanes[laneName];
                            const successClass = laneData.is_success ? 'table-success' : 'table-danger';
                            const teamsText = laneData.teams.map(t => `${t[0]}(${t[1]})`).join(', ');
                            return `
                                <div class="col-lg-4">
                                    <table class="table table-bordered table-sm">
                                        <thead><tr class="${successClass}"><th colspan="2">åˆ†çµ„çµæœ: ${laneName.charAt(0).toUpperCase() + laneName.slice(1)} Lane</th></tr></thead>
                                        <tbody>
                                            <tr><td>ç‹€æ…‹</td><td>${laneData.is_success ? 'é”æ¨™' : 'æœªé”æ¨™'}</td></tr>
                                            <tr><td>æˆå“¡æ•¸</td><td>${laneData.count} / 20</td></tr>
                                            <tr><td>å¯¦éš›æˆ°åŠ›</td><td>${laneData.total_power.toLocaleString()}</td></tr>
                                            <tr><td>ç›®æ¨™æˆ°åŠ›</td><td>${laneData.target.toLocaleString()}</td></tr>
                                            <tr><td>æˆ°åŠ›å·®é¡</td><td>${(laneData.difference >= 0 ? '+' : '') + laneData.difference.toLocaleString()}</td></tr>
                                            <tr><td colspan="2" class="team-list">${teamsText}</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            `;
                        }).join('');
                        allocationHtml = `<hr><h5>å»ºè­°åˆ†é…æ–¹æ¡ˆ</h5><div class="row g-3">${allocationTables}</div>`;
                    }
                    const summaryBadgeClass = (result.best_allocation && result.best_allocation.success) ? 'bg-success' : 'bg-warning text-dark';
                    elements.resultsDiv.innerHTML = `
                        <h5><span class="badge ${summaryBadgeClass}">${result.title}</span></h5>
                        <p><strong>è¨ˆç®—æ‘˜è¦ï¼š</strong> ${result.summary.replace(/\n/g, '<br>')}</p>
                        ${allocationHtml}
                    `;
                })
                .catch(error => {
                    elements.resultsDiv.innerHTML = `<div class="alert alert-danger"><h4>è¨ˆç®—æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼</h4><p>è«‹ç¢ºèªå¾Œç«¯ä¼ºæœå™¨ (app.py) æ­£åœ¨é‹è¡Œï¼Œä¸¦ä¸”æ²’æœ‰é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯ã€‚</p><hr><p class="mb-0"><strong>éŒ¯èª¤è©³æƒ…:</strong> ${error.message}</p></div>`;
                    console.error('Fetch Error:', error);
                });
            });
            elements.resetBtn.addEventListener('click', resetToDefaults);
            resetToDefaults();
        });
    </script>
</body>
</html>